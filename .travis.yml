language: haskell

sudo: false

# We test against different Stackage snapshots.
matrix:
  include:
    - env: BUILD=stack STACK_YAML=stack.yaml

    - env: BUILD=stack STACK_YAML=stack-lts-1.15.yaml

addons:
  apt:
    packages:
    - hlint
    - python
    - python-numpy

before_install:
 - export PATH=$HOME/.local/bin:$PATH
 - ./.travis-setup.sh

install:
 - stack --no-terminal test --only-dependencies
 - stack setup --stack-yaml $STACK_YAML
 - stack build --stack-yaml $STACK_YAML --only-dependencies

script:
 - stack --no-terminal test --haddock --no-haddock-deps
 - stack install --stack-yaml $STACK_YAML

# Now for integration testing
 - data/runtests.sh # Run integration test suite.
 - data/runtests.sh --compiler=futhark-py --exclude=no_python -c # Run integration test suite with Python code generator.
 - data/runtests.sh -t --exclude=no_opencl --compiler=futhark-pyopencl # Also test OpenCL code generation

 # Let us try checking out the benchmark suite for some more tests.
 - git clone https://github.com/HIPERFIT/futhark-benchmarks.git
 - (cd futhark-benchmarks && futhark-test --travis $(find . -name '*.fut') && futhark-test --travis -t --compiler=futhark-pyopencl $(find . -name '*.fut'))

 - tools/style-check.sh src # Check for style issues.

cache:
  directories:
    - $HOME/.stack

# EOF
